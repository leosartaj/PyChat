#!/usr/bin/env python2

##
# PyChat
# https://github.com/leosartaj/PyChat.git
#
# Copyright (c) 2014 Sartaj Singh
# Licensed under the MIT license.
##

# system imports
import sys
import os

# twisted imports
from twisted.internet import gtk2reactor
gtk2reactor.install() # install reactor for gui
from twisted.internet import reactor
from twisted.python import log
from twisted.internet import defer

# Other imports
from PyChat.client.gui.clientGUIClass import clientGUIClass # get the main gui class
from PyChat.client.gui.helper import helperFunc as hf
from PyChat.client.options import parse_args
from PyChat.server import start_server

if __name__ == '__main__':
    args = parse_args() # parse the arguments

    try:
        # Start Logging
        # Logs in pwd as pychat.log by default
        log.startLogging(open(args.log , 'a'))
    except Exception, e:
        print 'Cannot Start PyChat'
        print e
        sys.exit(1) # end program if invalid log file

    gui = clientGUIClass(args.client) # start the gui

    host, port = args.iface, args.port
    if host != None and hf.validate_host(host): # allow deafult connecting
        obj = gui.get_clientobj() # generate object
        result, factory = True, None
        if args.server:
            result, lisport, factory = start_server.listen(host, port)
        if result: # if everything goes well
            if factory: 
                obj.set_factory(lisport, factory)
            gui.connect(host, port, obj) # try to connect
        else: # incase server couldnt get started
            obj.updateView('server', __servfail__)

    reactor.run()
